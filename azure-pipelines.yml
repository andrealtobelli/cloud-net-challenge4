# ==========================================
# üöÄ Pipeline CI + CD - Projeto TrackZone (.NET)
# ==========================================
# Este pipeline:
#  1Ô∏è‚É£ Executa build, testes e publica artefatos (CI)
#  2Ô∏è‚É£ Faz deploy autom√°tico no Azure App Service (CD)
# ==========================================

trigger:
  branches:
    include:
      - main  

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  artifactName: 'drop'
  webAppName: 'trackzone-net-app'         
  resourceGroupName: 'rg-trackzone-net'   
  runtimeStack: 'DOTNETCORE|9.0'          
  packagePath: '$(Build.ArtifactStagingDirectory)/publish_output'

# ================================
# üß± STAGE 1: Build, Test & Publish
# ================================
stages:
  - stage: Build
    displayName: 'Build, Test e Publica√ß√£o do TrackZone'
    jobs:
      - job: BuildJob
        displayName: 'Compilar, testar e publicar o projeto .NET'
        steps:
          - checkout: self

          - task: UseDotNet@2
            displayName: 'Instalar SDK .NET 9.0'
            inputs:
              packageType: 'sdk'
              version: '9.0.x'

          - script: |
              echo "üîß Restaurando depend√™ncias..."
              dotnet restore

              echo "üèóÔ∏è Compilando projeto..."
              dotnet build --configuration $(buildConfiguration)

              echo "üß™ Executando testes..."
              dotnet test --configuration $(buildConfiguration) --no-build --logger "trx;LogFileName=test_results.trx"

              echo "üì¶ Publicando artefatos..."
              dotnet publish --configuration $(buildConfiguration) -o $(packagePath)
            displayName: 'Build, Test e Publish'

          - task: PublishTestResults@2
            displayName: 'Publicar resultados dos testes'
            inputs:
              testResultsFormat: 'VSTest'
              testResultsFiles: '**/test_results.trx'
              mergeTestResults: true

          - task: ArchiveFiles@2
            displayName: 'Compactar artefatos em .zip'
            inputs:
              rootFolderOrFile: '$(packagePath)'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/$(artifactName).zip'
              replaceExistingArchive: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publicar artefato para o pipeline'
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)'
              artifactName: '$(artifactName)'

# ================================
# üöÄ STAGE 2: Deploy no Azure App Service
# ================================
  - stage: Deploy
    displayName: 'Deploy autom√°tico no Azure App Service'
    dependsOn: Build
    condition: succeeded()

    jobs:
      - deployment: DeployJob
        displayName: 'Publicar TrackZone no App Service'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  displayName: 'Deploy no App Service (trackzone-net-app)'
                  inputs:
                    azureSubscription: 'trackzone-azure-conn'
                    appName: '$(webAppName)'
                    package: '$(Pipeline.Workspace)/drop/drop.zip'

                - script: |
                    echo "‚úÖ Deploy conclu√≠do com sucesso no App Service: $(webAppName)"
                  displayName: 'Confirma√ß√£o do deploy'

